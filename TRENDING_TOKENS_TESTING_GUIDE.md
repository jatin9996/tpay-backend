# TPay Trending Tokens - Testing Guide

## Overview
This guide helps you test the new "Tokens by 24H Volume" functionality using Postman. The system aggregates token volumes from pools and provides trending data via the `/tokens/trending` endpoint.

## Prerequisites
1. **MongoDB running** with seeded data
2. **TPay backend server** running on port 3001
3. **Postman** installed and ready

## Setup Steps

### 1. Start the Backend Server
```bash
cd tpay-backend
npm start
```

### 2. Verify Database is Seeded
```bash
npm run seed
```

### 3. Import Postman Collection
- Open Postman
- Click "Import" â†’ "Upload Files"
- Select `TPay_Trending_Tokens.postman_collection.json`

## Testing Scenarios

### Test 1: Basic Functionality
**Request:** `GET /tokens/trending`
**Expected Response:**
```json
{
  "success": true,
  "window": "24h",
  "tokens": [
    {
      "token": {
        "address": "0x7b79995e5f793A07Bc00c21412e50Ecae098E7f9",
        "symbol": "WETH",
        "name": "Wrapped Ether",
        "decimals": 18
      },
      "chainId": 11155111,
      "volume24hUSD": 350000.0,
      "trades24h": 0,
      "priceUSD": 0.0,
      "generatedAt": "2024-01-XX..."
    }
  ],
  "count": 1
}
```

### Test 2: Custom Limit
**Request:** `GET /tokens/trending?window=24h&limit=5`
**Expected:** Returns up to 5 tokens sorted by volume

### Test 3: Error Handling
**Request:** `GET /tokens/trending?window=7d&limit=10`
**Expected Response:**
```json
{
  "success": false,
  "error": "Only 24h window is supported currently"
}
```

### Test 4: Limit Validation
**Request:** `GET /tokens/trending?window=24h&limit=150`
**Expected:** Should cap at 100 results (limit validation)

## Background Job Testing

The trending data is generated by a background job that runs every 2 minutes. To test:

1. **Check initial state:** First call might return empty results
2. **Wait for job execution:** Wait 2-3 minutes for background job to run
3. **Verify data population:** Subsequent calls should return populated data

## Database Verification

### Check MongoDB Collections
```bash
# Connect to MongoDB
mongosh

# Switch to tpay database
use tpay

# View trending tokens collection
db.token_stats_24h.find().sort({volume24hUSD: -1})

# Check if data exists
db.token_stats_24h.countDocuments()
```

### Expected Data Structure
```json
{
  "_id": ObjectId("..."),
  "token": {
    "address": "0x7b79995e5f793A07Bc00c21412e50Ecae098E7f9",
    "symbol": "WETH",
    "name": "Wrapped Ether",
    "decimals": 18
  },
  "chainId": 11155111,
  "volume24hUSD": 350000.0,
  "trades24h": 0,
  "priceUSD": 0.0,
  "generatedAt": ISODate("2024-01-XX..."),
  "createdAt": ISODate("2024-01-XX..."),
  "updatedAt": ISODate("2024-01-XX...")
}
```

## Troubleshooting

### Common Issues

1. **Empty Results**
   - Check if database is seeded: `npm run seed`
   - Verify background job is running (check server logs)
   - Wait 2-3 minutes for job execution

2. **Server Not Responding**
   - Verify server is running on port 3001
   - Check MongoDB connection
   - Review server logs for errors

3. **Database Connection Issues**
   - Ensure MongoDB is running
   - Check connection string in `.env`
   - Verify database permissions

### Debug Commands

```bash
# Check server status
curl http://localhost:3001/search

# Check trending endpoint
curl "http://localhost:3001/tokens/trending?window=24h&limit=5"

# View server logs
# Check terminal where npm start is running
```

## Performance Testing

### Load Testing
- Test with different limit values (1, 10, 50, 100)
- Verify response times are consistent
- Check memory usage during high-load scenarios

### Data Freshness
- Background job runs every 2 minutes
- Data should be relatively fresh
- Check `generatedAt` timestamp in responses

## Expected Behavior Summary

1. **Initial State:** Empty results until background job runs
2. **After Job Execution:** Populated with token volume data
3. **Sorting:** Tokens sorted by `volume24hUSD` descending
4. **Pagination:** Respects `limit` parameter (1-100)
5. **Error Handling:** Proper validation for unsupported parameters
6. **Data Consistency:** Same results for identical requests

## Next Steps

After successful testing:
1. **Monitor background job performance**
2. **Verify data accuracy** against actual pool volumes
3. **Consider adding more time windows** (7d, 30d)
4. **Implement real-time swap event indexing** for live data
